# 8.カテゴリ別ランク設定

カテゴリ別にランク判定へ渡す数値パラメータを管理するためのガイドです。データベース上のマスタテーブルと、CSV を利用した運用フローについて記載します。

## 1. マスタ概要

- テーブル: `psi.category_rank_parameters`
- 主キー: `(rank_type, category_1, category_2)`
- カラム:
  - `rank_type` — 閾値の利用シーン（`FW` / `SS` など）を表す識別子。チェック制約で `'FW'` と `'SS'` のみ許可。
  - `category_1`, `category_2` — 分類コード。両方必須。
  - `threshold` — ランク判定に用いる数値（decimal）。

## 2. データ格納形式

リポジトリ内の `docs/data/category_rank_parameters.csv` に、以下の列順で UTF-8 CSV として格納します。

| 列名 | 必須 | 備考 |
| --- | --- | --- |
| `rank_type` | ✅ | `FW` または `SS` |
| `category_1` | ✅ | 半角英数字推奨 |
| `category_2` | ✅ | 半角英数字推奨 |
| `threshold` | ✅ | `0.00` 形式の 10 進数 |

> サンプル値は `docs/data/category_rank_parameters.csv` に格納しています。運用時は数値を上書きしてください。

## 3. 更新フロー

### 3.1 CSV インポート

1. `docs/data/category_rank_parameters.csv` を編集し、レビューを経て main ブランチにマージします。
2. 本番環境では、CSV をサーバーに配置した上で以下のコマンドで反映します。

   ```bash
   psql "$DATABASE_URL" <<'SQL'
   TRUNCATE TABLE psi.category_rank_parameters;
   \copy psi.category_rank_parameters FROM 'category_rank_parameters.csv' WITH (FORMAT csv, HEADER true);
   SQL
   ```

   - `DATABASE_URL` は Alembic と同じ接続文字列を利用します。
   - バックアップが必要な場合は `COPY psi.category_rank_parameters TO 'backup.csv' WITH (FORMAT csv, HEADER true);` を実行してください。

3. 反映後、`SELECT * FROM psi.category_rank_parameters ORDER BY rank_type, category_1, category_2;` で内容を確認します。

### 3.2 将来的な管理画面対応

- 管理画面が実装された際は、同テーブルを直接編集する機能を追加します。
- 画面側では `rank_type` をプルダウン（`FW` / `SS`）にし、CSV との整合性が取れるようバリデーションを実施してください。

## 4. バックエンド連携

後段で `backend/app/services/psi_report` などの集計ロジックからカテゴリ別閾値を参照する際は、本マスタをロードしてロジックに組み込みます。サービス層でのキャッシュ戦略や既存の PSI 指標との整合性は、具体的な要件が固まり次第検討します。
