# 2_データベース

**目的**: 現行の本番環境と同じ PostgreSQL スキーマ (`psi`) を再現するための DDL 一式です。ここでは、
アプリケーションが実際に利用しているテーブルと、今は未使用だが将来のために保持しているテーブルを
明確に分けて記載します。いずれの DDL も冪等 (`IF NOT EXISTS` / 存在確認) になるよう記述しています。

> **実行順序の推奨**: 1 つのセッションで上から順に流せば、既存オブジェクトがあっても安全に整合します。

---

## 0) 前提セットアップ

```sql
CREATE EXTENSION IF NOT EXISTS "pgcrypto";  -- gen_random_uuid() を利用
CREATE SCHEMA IF NOT EXISTS psi;
SET search_path TO psi, public;
```

---

## 1) アプリケーションが利用しているテーブル

### 1.1 セッション管理: `psi.sessions`

```sql
CREATE TABLE IF NOT EXISTS psi.sessions (
  id          uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  title       text NOT NULL,
  description text,
  is_leader   boolean NOT NULL DEFAULT false,
  created_at  timestamptz NOT NULL DEFAULT now(),
  updated_at  timestamptz NOT NULL DEFAULT now()
);

CREATE UNIQUE INDEX IF NOT EXISTS uq_sessions_leader_true
  ON psi.sessions (is_leader)
  WHERE is_leader = TRUE;
```

### 1.2 PSI 基礎データ: `psi.psi_base`

```sql
CREATE TABLE IF NOT EXISTS psi.psi_base (
  id              bigserial PRIMARY KEY,
  session_id      uuid NOT NULL REFERENCES psi.sessions(id) ON DELETE CASCADE,
  sku_code        text NOT NULL,
  sku_name        text,
  category_1      text,
  category_2      text,
  category_3      text,
  fw_rank         integer,
  ss_rank         integer,
  warehouse_name  text NOT NULL,
  channel         text NOT NULL,
  date            date NOT NULL,
  stock_at_anchor numeric,
  inbound_qty     numeric,
  outbound_qty    numeric,
  net_flow        numeric,
  stock_closing   numeric,
  safety_stock    numeric,
  movable_stock   numeric,
  created_at      timestamptz NOT NULL DEFAULT now()
);
```

### 1.3 PSI 編集データ: `psi.psi_edits`

```sql
CREATE TABLE IF NOT EXISTS psi.psi_edits (
  id             bigserial PRIMARY KEY,
  session_id     uuid NOT NULL REFERENCES psi.sessions(id) ON DELETE CASCADE,
  sku_code       text NOT NULL,
  warehouse_name text NOT NULL,
  channel        text NOT NULL,
  date           date NOT NULL,
  inbound_qty    numeric,
  outbound_qty   numeric,
  safety_stock   numeric,
  created_at     timestamptz NOT NULL DEFAULT now(),
  updated_at     timestamptz NOT NULL DEFAULT now()
);
```

### 1.4 編集ログ: `psi.psi_edit_log`

```sql
CREATE TABLE IF NOT EXISTS psi.psi_edit_log (
  id             bigserial PRIMARY KEY,
  session_id     uuid NOT NULL REFERENCES psi.sessions(id) ON DELETE CASCADE,
  sku_code       text NOT NULL,
  warehouse_name text NOT NULL,
  channel        text NOT NULL,
  date           date NOT NULL,
  field          text NOT NULL,
  old_value      numeric,
  new_value      numeric,
  edited_at      timestamptz NOT NULL DEFAULT now(),
  edited_by      text
);
```

### 1.5 PSI 指標マスタ: `psi.psi_metrics_master`

```sql
CREATE TABLE IF NOT EXISTS psi.psi_metrics_master (
  name          text PRIMARY KEY,
  is_editable   boolean NOT NULL DEFAULT false,
  display_order integer NOT NULL
);
```

### 1.6 チャネル振替: `psi.channel_transfers`

```sql
CREATE TABLE IF NOT EXISTS psi.channel_transfers (
  session_id    uuid NOT NULL REFERENCES psi.sessions(id) ON DELETE CASCADE,
  sku_code      text NOT NULL,
  warehouse_name text NOT NULL,
  transfer_date date NOT NULL,
  from_channel  text NOT NULL,
  to_channel    text NOT NULL,
  qty           numeric NOT NULL,
  note          text,
  created_at    timestamptz NOT NULL DEFAULT now(),
  updated_at    timestamptz NOT NULL DEFAULT now(),
  PRIMARY KEY (session_id, sku_code, warehouse_name, transfer_date, from_channel, to_channel)
);
```

### 1.7 認証系: `psi.users`, `psi.user_totp`, `psi.user_recovery_codes`

```sql
CREATE TABLE IF NOT EXISTS psi.users (
  id             uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  username       text NOT NULL UNIQUE,
  password_hash  text NOT NULL,
  is_active      boolean NOT NULL DEFAULT true,
  is_2fa_enabled boolean NOT NULL DEFAULT false,
  last_login_at  timestamptz,
  created_at     timestamptz NOT NULL DEFAULT now()
);
```

```sql
CREATE TABLE IF NOT EXISTS psi.user_totp (
  user_id      uuid PRIMARY KEY REFERENCES psi.users(id) ON DELETE CASCADE,
  totp_secret  text NOT NULL,
  created_at   timestamptz NOT NULL DEFAULT now(),
  last_used_at timestamptz
);
```

```sql
CREATE TABLE IF NOT EXISTS psi.user_recovery_codes (
  id        uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id   uuid NOT NULL REFERENCES psi.users(id) ON DELETE CASCADE,
  code_hash text NOT NULL,
  used_at   timestamptz
);

CREATE INDEX IF NOT EXISTS idx_user_recovery_codes_user
  ON psi.user_recovery_codes (user_id);
```

> `users.is_admin` カラムは後続のマイグレーションで追加され、既定値は `false` です。

---

## 2) 現在は未使用だが保持しているテーブル

アプリケーションコードからは参照していないものの、将来的な拡張や手動オペレーションのために残しているテーブルです。

### 2.1 マスタ類

```sql
CREATE TABLE IF NOT EXISTS psi.sku_master (
  sku_code text PRIMARY KEY,
  sku_name text NOT NULL,
  category_1 text,
  category_2 text,
  category_3 text,
  style_color text,
  suggested_retail_price numeric,
  cost_price numeric
);

CREATE TABLE IF NOT EXISTS psi.warehouse_master (
  warehouse_name text PRIMARY KEY,
  region text
);

CREATE TABLE IF NOT EXISTS psi.channel_master (
  channel text PRIMARY KEY,
  display_name text
);
```

### 2.2 需要計画・日別キャッシュ

```sql
CREATE TABLE IF NOT EXISTS psi.demand_plan_daily (
  id             bigserial PRIMARY KEY,
  session_id     uuid NOT NULL REFERENCES psi.sessions(id) ON DELETE CASCADE,
  sku_code       text NOT NULL,
  warehouse_name text NOT NULL,
  channel        text NOT NULL,
  date           date NOT NULL,
  forecast_qty   numeric NOT NULL
);

CREATE TABLE IF NOT EXISTS psi.psi_daily_cache (
  session_id     uuid NOT NULL REFERENCES psi.sessions(id) ON DELETE CASCADE,
  sku_code       text NOT NULL,
  warehouse_name text NOT NULL,
  channel        text NOT NULL,
  date           date NOT NULL,
  category_1     text,
  category_2     text,
  category_3     text,
  fw_rank        integer,
  ss_rank        integer,
  stock_at_anchor numeric,
  inbound_qty     numeric,
  outbound_qty    numeric,
  net_flow        numeric,
  stock_closing   numeric,
  safety_stock    numeric,
  movable_stock   numeric,
  last_refreshed  timestamptz NOT NULL DEFAULT now(),
  PRIMARY KEY (session_id, sku_code, warehouse_name, channel, date)
);
```

### 2.3 セッション別パラメータ

```sql
CREATE TABLE IF NOT EXISTS psi.session_params (
  session_id uuid NOT NULL REFERENCES psi.sessions(id) ON DELETE CASCADE,
  key        text NOT NULL,
  value      text NOT NULL,
  PRIMARY KEY (session_id, key)
);
```

### 2.4 倉庫移動履歴

```sql
CREATE TABLE IF NOT EXISTS psi.stock_transfers (
  id            bigserial PRIMARY KEY,
  session_id    uuid NOT NULL REFERENCES psi.sessions(id) ON DELETE CASCADE,
  sku_code      text NOT NULL,
  from_warehouse text,
  to_warehouse   text,
  channel        text,
  qty            numeric NOT NULL,
  transfer_date  date NOT NULL,
  note           text
);
```

---

## 3) Alembic 管理テーブル

Alembic によるマイグレーション履歴を追跡するためのテーブルです。アプリケーションコードからは直接参照しません。

```sql
CREATE TABLE IF NOT EXISTS psi.alembic_version (
  version_num varchar PRIMARY KEY
);
```

---

## 4) 動作確認用クイックチェック

```sql
SELECT to_regclass('psi.sessions')   AS sessions;
SELECT to_regclass('psi.psi_base')   AS psi_base;
SELECT to_regclass('psi.users')      AS users;
SELECT to_regclass('psi.channel_transfers') AS channel_transfers;
```

```sql
-- テスト用のセッションを追加
INSERT INTO psi.sessions (title, description, is_leader)
VALUES ('Demo Session', 'sanity check', true)
ON CONFLICT (id) DO NOTHING;

-- 直近のセッションに紐付けた PSI データを 1 行追加
INSERT INTO psi.psi_base (session_id, sku_code, warehouse_name, channel, date, stock_at_anchor)
VALUES (
  (SELECT id FROM psi.sessions ORDER BY created_at DESC LIMIT 1),
  'SKU001', 'Main WH', 'online', CURRENT_DATE, 100
)
ON CONFLICT DO NOTHING;
```
